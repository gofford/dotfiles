#!/usr/bin/env bash

set -euo pipefail

DOTBOT_DIR="dotbot"
DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "${BASEDIR}"

# Submodule prep runs once regardless of how many steps follow.
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive

# Default: run all install steps in order.
DEFAULT_CONFIGS=(
	"steps/01-bootstrap.yaml"
	"steps/02-brew-core.yaml"
	"steps/03-brew-casks.yaml"
	"steps/04-brew-appstore.yaml"
	"steps/05-shell.yaml"
	"steps/06-dev.yaml"
	"steps/07-system.yaml"
	"steps/08-brew-extensions.yaml"
)

# Argument handling:
#   no args              => run all default configs
#   -c <config>          => run a single config (e.g. ./install -c steps/05-shell.yaml)
#   <file.yaml> ...      => run each named config in order
if [[ $# -eq 0 ]]; then
	CONFIGS=("${DEFAULT_CONFIGS[@]}")
elif [[ $# -eq 2 && "$1" == "-c" ]]; then
	CONFIGS=("$2")
else
	CONFIGS=("$@")
fi

# Run Dotbot once per config â€” it does not support multiple --config-file flags.
for cfg in "${CONFIGS[@]}"; do
    echo "==> Running: ${cfg}"
    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" \
        --verbose \
        --base-directory "${BASEDIR}" \
        --plugin-dir "dotbot-brewfile" \
        --config-file "${cfg}"
done
