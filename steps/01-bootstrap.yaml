- defaults:
    link:
      relink: true
      force: true

# Bootstrap shell - install essential brew packages
- shell:
    - description: Install essential packages for bootstrap
      command: |
        shell_path="$(brew --prefix)/bin/zsh"
        if [ ! -x "${shell_path}" ]; then
          brew install zsh
        fi

- shell:
    - description: Change default shell to Homebrew Zsh
      quiet: false
      command: |
        update_shell() {
          local shell_path;
          shell_path="$(brew --prefix)/bin/zsh"

          if [ ! -x "${shell_path}" ]; then
            echo "Homebrew zsh not found at ${shell_path}; installing..."
            brew install zsh
          fi

          # Only add to /etc/shells if not already present
          if ! grep -q "^${shell_path}$" /etc/shells 2>/dev/null; then
            echo "Adding ${shell_path} to /etc/shells..."
            sudo sh -c "echo $shell_path >> /etc/shells"
          fi

          # Only change shell if not already set
          if [ "$SHELL" != "$shell_path" ]; then
            echo "Changing default shell to ${shell_path}..."
            sudo chsh -s "$shell_path" "$USER"
          else
            echo "Shell already set to ${shell_path}"
          fi
        }

        update_shell

# Clean and create directories
- clean:
    ~/.config:
      recursive: true

- create:
    - ~/.config
    - ~/.config/direnv
    - ~/.config/sheldon
    - ~/.config/atuin
    - ~/.config/ghostty
    - ~/.ssh
    - ~/.config/zsh
    - ~/.config/zsh/completions

# Final setup
- shell:
    - command: touch ~/.hushlogin
      description: Disable login message
    - command: brew install rcmdnk/file/brew-file
      description: Install homebrew-file plugin for package management
